<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Split</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/uppy/3.17.0/uppy.css"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/uppy/3.17.0/uppy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.4.0/dist/pdf-lib.min.js"></script>
    <script src="./jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/downloadjs@1.4.7/download.min.js"></script>

    <!-- <script src="https://www.jsdelivr.com/package/npm/pdfjs-dist"></script> -->
    <script src="./pdf.js"></script>

    <style>
      body {
        padding: 0;
        margin: 0;
      }
      #container {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 3rem;
        height: 100vh;
      }

      #header {
        display: flex;
        justify-content: center;
        align-items: center;
        text-transform: uppercase;
        background-color: rgb(228, 99, 99);
        color: white;
        font-weight: bold;
        height: 10vh;
        font-size: 2rem;
      }

      #body {
        display: flex;
      }

      #sidebar {
        width: 20rem;
        height: 90vh;
        background-color: rgb(51, 51, 202);
      }

      #main {
        flex-grow: 1;
        height: 90vh;
        background-color: rgb(27, 226, 166);

        display: flex;
        justify-content: center;
        align-items: center;
      }

      #uppy {
        padding: 1rem;
        cursor: pointer;
        background: lightblue;
      }

      #error {
        height: 100vh;
        width: 100vh;
        z-index: 1000;
        position: absolute;
        top: 0;
        left: 0;
        background-repeat: no-repeat;
        background-size: 100% 100%;
        background-position: center;
        background-origin: 0% 0;
        display: none;
        background-image: url("https://media.makeameme.org/created/youre-not-authorized-8b29bd98c8.jpg");
      }
    </style>
  </head>
  <body>
    <!-- <div>ahoyyyyy</div> -->

    <div id="container">
      <!-- <form
        onsubmit="event.preventDefault()"
        enctype="multipart/form-data"
        method="post"
        action=""
      >
        <input id="upload" type="file" name="file" accept="application/pdf" />

        <button type="submit" id="btn-submit">Submit</button>
      </form> -->

      <div id="header">get those subdocuments</div>

      <div id="body">
        <div id="sidebar"></div>

        <div id="main">
          <!-- <button id="uppy">Upload a PDF</button> -->

          <canvas></canvas>
        </div>
      </div>
    </div>

    <div id="error"></div>

    <script type="module">
      const { Dashboard, Webcam, Tus } = Uppy;

      const uppy = new Uppy.Uppy({
        debug: true,
        autoProceed: false,
        restrictions: {
          allowedFileTypes: [".pdf"],
        },
      }).use(Dashboard, { trigger: "#uppy" });

      uppy.on("upload", (data) => {
        const id = data.fileIDs[0];

        // console.log("file", uppy.getFile(id));
        const reader = new FileReader();
        reader.readAsArrayBuffer(uppy.getFile(id).data);
        reader.onload = async () => {
          console.log("Loaded reader data!");
          zipAndDownload(reader.result);
        };
      });

      const desiredSubdocumentsRaw = `1-3: Contact Information
4: IPP Participation Agreement
5-6: Telehealth Agreement
7-8: Participant Rights
9: Privacy Practices
10-11: Informed Consent
12: Telehealth Consent
13-14: Attendance Policy
15: IPP Goals
16-17: Collateral ROI
18: Partner ROI
19: Email ROI
20: Therapy Fee
21: Emergency Plan
22: Insurance Information
23: Insurance Authorization `;

      const desiredSubdocuments = desiredSubdocumentsRaw
        .split("\n")
        .map((line) => {
          const [range, title] = line.split(": ");
          const [start, end] = range.split("-").map((x) => parseInt(x));
          const realRange = [start - 1];
          if (end) {
            realRange.push(end - 1);
          }
          return { title, range: realRange };
        });

      const pdfjsLib = window["pdfjs-dist/build/pdf"];

      pdfjsLib.GlobalWorkerOptions.workerSrc = "./pdf.worker.js";

      console.log("pdfJS...", window.pdfjsLib);

      const canvas = document.querySelector("canvas");
      const ctx = canvas.getContext("2d");

      const task = pdfjsLib.getDocument("./test.pdf");
      task.promise.then((x) => {
        console.log("Loaded", x);

        x.getData().then((arrayBuffer) => {
          console.log("We got it bro", arrayBuffer);
          zipAndDownload(arrayBuffer);
        });

        // This works perfect to render the PDF, showing that we do in fact have access to it
        x.getPage(1).then((page) => {
          console.log("PAGE 1", page);

          page.getTextContent().then((content) => {
            console.log("page content", content);
          });

          let viewport = page.getViewport({ scale: 1 });
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          let renderContext = {
            canvasContext: ctx,
            viewport: viewport,
          };
          page.render(renderContext);
        });
      });

      async function zipAndDownload(documentAsBytes) {
        // Ahhhhh fudge, even if we get bytes from PDFJS....... it still shows as unauthorized. AUGH.

        const { PDFDocument } = window.PDFLib;
        try {
          const pdfDoc = await PDFDocument.load(documentAsBytes);
          console.log("got doc...", pdfDoc);

          /**
           * This is PDF-lib code that works fine either on client or server:
           * (However, the PDF must not be encrypted.)
           */

          // const zip = new JSZip();
          // console.log("zip...", zip);

          // for (const { title, range } of desiredSubdocuments) {
          //   // console.log("title", title, range);
          //   const subDocument = await PDFDocument.create();
          //   const copiedPages = await subDocument.copyPages(pdfDoc, range);
          //   for (const p of copiedPages) {
          //     subDocument.addPage(p);
          //   }
          //   const pdfBytes = await subDocument.save();

          //   zip.file(`${title}.pdf`, pdfBytes, { binary: true });
          // }

          // const content = await zip.generateAsync({ type: "binarystring" });

          // download(content, "testZip.zip", "application/zip");
        } catch (e) {
          console.log("inner error", e);
          document.getElementById("error").style.display = "block";

          // TODO: DISPLAY ERROR TO USER
        }
      }

      document.getElementById("error").addEventListener("click", () => {
        document.getElementById("error").style.display = "none";
      });

      /**
       * I think this is neat and I want to remember it lol.. so weird you can't grab the fileInfo off the dom element NOW, though...
       */

      // async function handleSubmit() {
      //   // Yesss!!!
      //   const reader = new FileReader();
      //   reader.readAsArrayBuffer(fileInfo[0]);
      //   reader.onload = async () => {
      //     // Wow, this worked (ths window...)
      //     zipAndDownload(reader.result);
      //   };
      // }
    </script>
  </body>
</html>
